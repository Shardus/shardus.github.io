<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Building a PoC App | Developer Docs</title>
    <meta name="description" content="Shardus Documentation Developer Docs">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/docs2/assets/css/0.styles.a15dee42.css" as="style"><link rel="preload" href="/docs2/assets/js/app.4fedb86a.js" as="script"><link rel="preload" href="/docs2/assets/js/2.3fd0cf3c.js" as="script"><link rel="preload" href="/docs2/assets/js/17.e52dce7c.js" as="script"><link rel="prefetch" href="/docs2/assets/js/10.c8f90647.js"><link rel="prefetch" href="/docs2/assets/js/11.37afdd34.js"><link rel="prefetch" href="/docs2/assets/js/12.d4808882.js"><link rel="prefetch" href="/docs2/assets/js/13.89c0170a.js"><link rel="prefetch" href="/docs2/assets/js/14.0650ba29.js"><link rel="prefetch" href="/docs2/assets/js/15.6b3c6a63.js"><link rel="prefetch" href="/docs2/assets/js/16.94b4b93c.js"><link rel="prefetch" href="/docs2/assets/js/18.805f0b18.js"><link rel="prefetch" href="/docs2/assets/js/19.64845a7b.js"><link rel="prefetch" href="/docs2/assets/js/20.395bbe02.js"><link rel="prefetch" href="/docs2/assets/js/21.060e90c4.js"><link rel="prefetch" href="/docs2/assets/js/22.69ee7234.js"><link rel="prefetch" href="/docs2/assets/js/23.730f4a89.js"><link rel="prefetch" href="/docs2/assets/js/24.e9661cf2.js"><link rel="prefetch" href="/docs2/assets/js/25.b88ed052.js"><link rel="prefetch" href="/docs2/assets/js/26.0a46c1b0.js"><link rel="prefetch" href="/docs2/assets/js/27.d1a5d31e.js"><link rel="prefetch" href="/docs2/assets/js/28.b03d88a5.js"><link rel="prefetch" href="/docs2/assets/js/29.926bb12f.js"><link rel="prefetch" href="/docs2/assets/js/3.d41181b0.js"><link rel="prefetch" href="/docs2/assets/js/30.fc7d3d57.js"><link rel="prefetch" href="/docs2/assets/js/31.d4e4aa7d.js"><link rel="prefetch" href="/docs2/assets/js/32.b4459487.js"><link rel="prefetch" href="/docs2/assets/js/33.3a0ede7d.js"><link rel="prefetch" href="/docs2/assets/js/34.86c50212.js"><link rel="prefetch" href="/docs2/assets/js/35.89be3532.js"><link rel="prefetch" href="/docs2/assets/js/36.09e568d9.js"><link rel="prefetch" href="/docs2/assets/js/37.ea9bfe32.js"><link rel="prefetch" href="/docs2/assets/js/38.0c09315a.js"><link rel="prefetch" href="/docs2/assets/js/39.d5eba328.js"><link rel="prefetch" href="/docs2/assets/js/4.bdc95c51.js"><link rel="prefetch" href="/docs2/assets/js/40.f134f176.js"><link rel="prefetch" href="/docs2/assets/js/41.2edff556.js"><link rel="prefetch" href="/docs2/assets/js/42.49878b4e.js"><link rel="prefetch" href="/docs2/assets/js/43.c99e0426.js"><link rel="prefetch" href="/docs2/assets/js/44.6bce92a7.js"><link rel="prefetch" href="/docs2/assets/js/45.efc9c512.js"><link rel="prefetch" href="/docs2/assets/js/46.567954e6.js"><link rel="prefetch" href="/docs2/assets/js/47.ac9ca5d5.js"><link rel="prefetch" href="/docs2/assets/js/48.e64957d7.js"><link rel="prefetch" href="/docs2/assets/js/49.1cdf48ac.js"><link rel="prefetch" href="/docs2/assets/js/5.70dbfd4e.js"><link rel="prefetch" href="/docs2/assets/js/50.a66c1e36.js"><link rel="prefetch" href="/docs2/assets/js/51.024c1df3.js"><link rel="prefetch" href="/docs2/assets/js/52.01271f85.js"><link rel="prefetch" href="/docs2/assets/js/53.e7bf447f.js"><link rel="prefetch" href="/docs2/assets/js/54.44e77f2a.js"><link rel="prefetch" href="/docs2/assets/js/55.da9796f2.js"><link rel="prefetch" href="/docs2/assets/js/56.a43a8ca0.js"><link rel="prefetch" href="/docs2/assets/js/57.192b008d.js"><link rel="prefetch" href="/docs2/assets/js/58.b6af1112.js"><link rel="prefetch" href="/docs2/assets/js/6.e910ed1d.js"><link rel="prefetch" href="/docs2/assets/js/7.6d6a826f.js"><link rel="prefetch" href="/docs2/assets/js/8.a3f31b66.js"><link rel="prefetch" href="/docs2/assets/js/9.0a5314d4.js">
    <link rel="stylesheet" href="/docs2/assets/css/0.styles.a15dee42.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs2/" class="home-link router-link-active"><img src="/docs2/logo.png" alt="Developer Docs" class="logo"> <span class="site-name can-hide">Developer Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Installation</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Main Concepts</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/docs2/source/main-concepts/shardus-cli-tool/shardus-cli-tool.html" class="sidebar-heading clickable"><span>Shardus CLI Tools</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/docs2/source/main-concepts/application-fundamentals/application-fundamentals.html" class="sidebar-heading clickable"><span>Application Fundementals</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/docs2/source/main-concepts/building-a-poc-app/general.html" class="sidebar-heading clickable open"><span>Building a PoC App</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html" class="active sidebar-link">Building a PoC App</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#initialization" class="sidebar-link">Initialization</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#account-model" class="sidebar-link">Account Model</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#post-requests" class="sidebar-link">POST requests</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#get-requests" class="sidebar-link">GET requests</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#register" class="sidebar-link">register</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#message" class="sidebar-link">message</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#toll" class="sidebar-link">toll</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#friend" class="sidebar-link">friend</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#node-reward" class="sidebar-link">node_reward</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#start-the-app" class="sidebar-link">Start the app</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#write-a-cli" class="sidebar-link">Write a CLI</a></li><li class="sidebar-sub-header"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-poc-app.html#interact" class="sidebar-link">Interact</a></li></ul></li><li><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-reward-system.html" class="sidebar-link">Building a reward system</a></li><li><a href="/docs2/source/main-concepts/building-a-poc-app/private-messaging.html" class="sidebar-link">Private messaging</a></li><li><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-frontend/building-a-frontend.html" class="sidebar-link">Building a frontend</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/docs2/source/main-concepts/poc-to-production/poc-to-production.html" class="sidebar-heading clickable"><span>Poc To Production</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/docs2/source/main-concepts/spamming-the-network/spamming-the-network.html" class="sidebar-heading clickable"><span>Spamming The Network</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SDK Reference</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/docs2/source/support-and-feedback/raise-an-issue-on-gitlab.html" class="sidebar-link">Support and Feedback</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="building-a-poc-app-simple-messaging-application"><a href="#building-a-poc-app-simple-messaging-application" class="header-anchor">#</a> Building a PoC App (Simple messaging application)</h1> <h2 id="initialization"><a href="#initialization" class="header-anchor">#</a> Initialization</h2> <blockquote><p>We initialize a few modules at the top of our index.js file</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shardus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;shardus-enterprise-server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;shardus-crypto-utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">crypto</span><span class="token punctuation">(</span><span class="token string">&quot;64f152869ca2d473e4ba64ab53f49ccdb2edae22da192c126850970e788af347&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> configFile <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;config.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> payAcc <span class="token operator">=</span> config<span class="token punctuation">.</span>payAcc<span class="token punctuation">;</span> <span class="token comment">// This can be set to the public address you want to get paid for running the node</span>
</code></pre></div><h2 id="account-model"><a href="#account-model" class="header-anchor">#</a> Account Model</h2> <p>The model for accounts on the network will be fairly simple. Each account will have an id, timestamp, balance, toll, chats, and friends. A hash of the account will be taken when it's created and added on additionally. For a simple, non-production test application, we can simply store the accounts as an object in our index.js code:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> accounts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>Now we can implement a function to call when we need to our network to create an account</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createAccount</span><span class="token punctuation">(</span><span class="token parameter">obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> account <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        balance<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        toll<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        chats<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        friends<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    obj
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  account<span class="token punctuation">.</span>hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">hashObj</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> account<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="post-requests"><a href="#post-requests" class="header-anchor">#</a> POST requests</h2> <blockquote><p>We need to add at least one <code>POST</code> request to our index.js in order to accept a transaction injection for <code>shardus</code> to process.</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>dapp<span class="token punctuation">.</span><span class="token function">registerExternalPost</span><span class="token punctuation">(</span><span class="token string">&quot;inject&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> dapp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="get-requests"><a href="#get-requests" class="header-anchor">#</a> GET requests</h2> <blockquote><p>We need a few GET requests for reading data from the network</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>dapp<span class="token punctuation">.</span><span class="token function">registerExternalGet</span><span class="token punctuation">(</span><span class="token string">&quot;account/:id&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> account <span class="token operator">=</span> accounts<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> account <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

dapp<span class="token punctuation">.</span><span class="token function">registerExternalGet</span><span class="token punctuation">(</span><span class="token string">&quot;account/:id/:friendId/toll&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> friendId <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">&quot;friendId&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>friendId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;No provided friendId &quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> account <span class="token operator">=</span> accounts<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>account <span class="token operator">&amp;&amp;</span> account<span class="token punctuation">.</span>data<span class="token punctuation">.</span>friends<span class="token punctuation">[</span>friendId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> toll<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> toll<span class="token operator">:</span> account<span class="token punctuation">.</span>data<span class="token punctuation">.</span>toll <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;No account found with the given id&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

dapp<span class="token punctuation">.</span><span class="token function">registerExternalGet</span><span class="token punctuation">(</span><span class="token string">&quot;accounts&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> accounts <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

dapp<span class="token punctuation">.</span><span class="token function">registerExternalGet</span><span class="token punctuation">(</span>
  <span class="token string">&quot;messages/:accountId/:chatId/:timestamp&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> accountId<span class="token punctuation">,</span> chatId<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>accounts<span class="token punctuation">[</span>accountId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;AccountId doesn't exist&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>accounts<span class="token punctuation">[</span>accountId<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>chatId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">&quot;no chat history for this request&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span>accounts<span class="token punctuation">[</span>accountId<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>chatId<span class="token punctuation">]</span><span class="token punctuation">.</span>sent<span class="token punctuation">,</span>
        <span class="token operator">...</span>accounts<span class="token punctuation">[</span>accountId<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>chatId<span class="token punctuation">]</span><span class="token punctuation">.</span>received
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      messages <span class="token operator">=</span> messages
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">message</span> <span class="token operator">=&gt;</span> message<span class="token punctuation">.</span>timestamp <span class="token operator">&gt;</span> timestamp<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>timestamp <span class="token operator">-</span> b<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> messages <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="transaction-types"><a href="#transaction-types" class="header-anchor">#</a> Transaction types</h1> <h2 id="register"><a href="#register" class="header-anchor">#</a> register</h2> <blockquote><p>We need a way for the client to request unique handles, or &quot;usernames&quot; on the network. Lets create a &quot;handle&quot; type of transaction to add this functionality.</p></blockquote> <ol><li>Add a case for <code>validateTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;register&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token punctuation">.</span>owner <span class="token operator">!==</span> srcAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;not signed by source account&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">verifyObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;incorrect signing&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> handles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">account</span> <span class="token operator">=&gt;</span> account<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>handles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This handle is already taken&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction is valid!&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Add a case for <code>apply</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;register&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  source<span class="token punctuation">.</span>handle <span class="token operator">=</span> tx<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Add a case for <code>getKeyFromTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;register&quot;</span><span class="token operator">:</span>
  result<span class="token punctuation">.</span>targetKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>srcAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="message"><a href="#message" class="header-anchor">#</a> message</h2> <ol><li>Add a case for <code>validateTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;message&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token punctuation">.</span>owner <span class="token operator">!==</span> srcAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;not signed by source account&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">verifyObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;incorrect signing&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">||</span> source <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">'&quot;source&quot; account does not exist.'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">'&quot;target&quot; account does not exist.'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>amount <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span>
      <span class="token string">&quot;Must send at least 1 token with the message transaction&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>friends<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>srcAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Source account does not have sufficient funds.&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> amount <span class="token operator">||</span>
      source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>toll
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Source account does not have sufficient funds.&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction is valid!&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Add a case for <code>apply</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;message&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">+=</span> amount<span class="token punctuation">;</span>

  message<span class="token punctuation">.</span>handle <span class="token operator">=</span> source<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>tgtAddress<span class="token punctuation">]</span><span class="token punctuation">)</span>
    source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>tgtAddress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> sent<span class="token operator">:</span> <span class="token punctuation">[</span>message<span class="token punctuation">]</span><span class="token punctuation">,</span> received<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>tgtAddress<span class="token punctuation">]</span><span class="token punctuation">.</span>sent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>srcAddress<span class="token punctuation">]</span><span class="token punctuation">)</span>
    target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>srcAddress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> sent<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> received<span class="token operator">:</span> <span class="token punctuation">[</span>message<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>chats<span class="token punctuation">[</span>srcAddress<span class="token punctuation">]</span><span class="token punctuation">.</span>received<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

  source<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Add a case for <code>getKeyFromTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;message&quot;</span><span class="token operator">:</span>
  result<span class="token punctuation">.</span>targetKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>tgtAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span>sourceKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>srcAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="toll"><a href="#toll" class="header-anchor">#</a> toll</h2> <ol><li>Add a case for <code>validateTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;toll&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token punctuation">.</span>owner <span class="token operator">!==</span> srcAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;not signed by source account&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">verifyObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;incorrect signing&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Source account does not exist&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Source account does not have sufficient funds.&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Must burn 1 token in order to set a toll&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction is valid!&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Add a case for <code>apply</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;toll&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>toll <span class="token operator">=</span> toll<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Add a case for <code>getKeyFromTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;toll&quot;</span><span class="token operator">:</span>
  result<span class="token punctuation">.</span>targetKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>srcAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="friend"><a href="#friend" class="header-anchor">#</a> friend</h2> <ol><li>Add a case for <code>validateTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;friend&quot;</span><span class="token operator">:</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">||</span> source <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Source account does not exist&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Target account does not exist&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction is valid!&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>Add a case for <code>apply</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;friend&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>data<span class="token punctuation">.</span>friends<span class="token punctuation">[</span>handle<span class="token punctuation">]</span> <span class="token operator">=</span> tgtAddress<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Add a case for <code>getKeyFromTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;friend&quot;</span><span class="token operator">:</span>
  result<span class="token punctuation">.</span>targetKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>srcAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="node-reward"><a href="#node-reward" class="header-anchor">#</a> node_reward</h2> <ol><li>Add a case for <code>validateTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;node_reward&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> nodeInfo <span class="token operator">=</span> dapp<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>nodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>timestamp <span class="token operator">-</span> nodeInfo<span class="token punctuation">.</span>activeTimestamp <span class="token operator">&lt;</span> <span class="token constant">NODE_REWARD_TIME</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Too early for this node to get paid&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction in valid&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span>nodeRewardTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction in valid&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>timestamp <span class="token operator">-</span> source<span class="token punctuation">.</span>nodeRewardTime <span class="token operator">&lt;</span> <span class="token constant">NODE_REWARD_TIME</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;Too early for this node to get paid&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  response<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token string">&quot;This transaction is valid!&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Add a case for <code>apply</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;node_reward&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>balance <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>nodeRewardTime <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  source<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Add a case for <code>getKeyFromTransaction</code></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">case</span> <span class="token string">&quot;node_reward&quot;</span><span class="token operator">:</span>
  result<span class="token punctuation">.</span>sourceKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>srcAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span>targetKeys <span class="token operator">=</span> <span class="token punctuation">[</span>tx<span class="token punctuation">.</span>tgtAcc<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="start-the-app"><a href="#start-the-app" class="header-anchor">#</a> Start the app</h2> <blockquote><p>That's pretty much everything we need on the server for a very simple messaging app to work, with tolls and friends, and mining. All that's left is to write code to start the application:</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">NODE_REWARD_TIME</span> <span class="token operator">=</span> <span class="token number">86400</span><span class="token punctuation">;</span> <span class="token comment">// 86400 for 24H</span>
<span class="token keyword">const</span> <span class="token constant">NODE_REWARD_AMOUNT</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// 50 tokens for runing a node for 24 hours</span>

<span class="token keyword">function</span> <span class="token function">selfReward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nodeId <span class="token operator">=</span> dapp<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> dapp<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span>nodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tgtAcc <span class="token operator">=</span> payAcc <span class="token operator">||</span> address<span class="token punctuation">;</span>
  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;node_reward&quot;</span><span class="token punctuation">,</span>
    timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nodeId<span class="token operator">:</span> nodeId<span class="token punctuation">,</span>
    srcAcc<span class="token operator">:</span> address<span class="token punctuation">,</span>
    tgtAcc<span class="token operator">:</span> tgtAcc<span class="token punctuation">,</span>
    amount<span class="token operator">:</span> <span class="token constant">NODE_REWARD_AMOUNT</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  dapp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

dapp<span class="token punctuation">.</span><span class="token function">registerExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> dapp<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">selfReward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">NODE_REWARD_TIME</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="write-a-cli"><a href="#write-a-cli" class="header-anchor">#</a> Write a CLI</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vorpal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vorpal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> got <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;got&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;shardus-crypto-utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">crypto</span><span class="token punctuation">(</span><span class="token string">&quot;64f152869ca2d473e4ba64ab53f49ccdb2edae22da192c126850970e788af347&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> walletFile <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;./wallet.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> walletEntries <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  walletEntries <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>walletFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">saveEntries</span><span class="token punctuation">(</span>walletEntries<span class="token punctuation">,</span> walletFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Created wallet file '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>walletFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">saveEntries</span><span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringifiedEntries <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> stringifiedEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createAccount</span><span class="token punctuation">(</span><span class="token parameter">keys <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeypair</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    address<span class="token operator">:</span> keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
    keys
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Creates an account with a keypair and adds it to the clients walletFile</span>
<span class="token keyword">function</span> <span class="token function">createEntry</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> account <span class="token operator">=</span> <span class="token function">createAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">||</span> id <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  account<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  walletEntries<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> account<span class="token punctuation">;</span>
  <span class="token function">saveEntries</span><span class="token punctuation">(</span>walletEntries<span class="token punctuation">,</span> walletFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> account<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Loaded wallet entries from '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>walletFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> host <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;localhost:9001&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getInjectUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/inject</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getAccountsUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accounts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getAccountUrl</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/account/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Using </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> as coin-app node for queries and transactions.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">postJSON</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">got</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;content-type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * interface tx {
 *   type: string
 *   from: string,
 *   to: string,
 *   amount: number,
 *   timestamp: number
 * }
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">injectTx</span><span class="token punctuation">(</span><span class="token parameter">tx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">postJSON</span><span class="token punctuation">(</span><span class="token function">getInjectUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getAccountData</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">got</span><span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">!==</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> <span class="token function">getAccountUrl</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">getAccountsUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getToll</span><span class="token punctuation">(</span><span class="token parameter">friendId<span class="token punctuation">,</span> yourId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">got</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/account/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>friendId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>yourId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/toll</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> toll <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> toll<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">pollMessages</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> timestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">got</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/messages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>to<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">from</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;use &lt;host&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Uses the given &lt;host&gt; as the coin-app node for queries and transactions.&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    host <span class="token operator">=</span> args<span class="token punctuation">.</span>host<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Set </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> as coin-app node for transactions.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;wallet create &lt;name&gt; [id]&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Creates a wallet with the given &lt;name&gt; and [id]. Makes [id] = hash(&lt;name&gt;) if [id] is not given.&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span>
      walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Wallet named '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' already exists.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> publicKey <span class="token operator">=</span> <span class="token function">createEntry</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>name<span class="token punctuation">,</span> args<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Created wallet '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">': '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publicKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;wallet list [name]&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Lists wallet for the given [name]. Otherwise, lists all wallets.&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> wallet <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> wallet <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> wallet <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>wallet<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>walletEntries<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;handle create &lt;handle&gt; &lt;source&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Creates a unique handle for the &lt;source&gt; account on the server&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>source<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;register&quot;</span><span class="token punctuation">,</span>
      handle<span class="token operator">:</span> args<span class="token punctuation">.</span>handle<span class="token punctuation">,</span>
      srcAcc<span class="token operator">:</span> source<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    crypto<span class="token punctuation">.</span><span class="token function">signObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">injectTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;friend add &lt;target&gt; &lt;source&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;adds a friend &lt;target&gt; to account &lt;source&gt;&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>source<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>target<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;friend&quot;</span><span class="token punctuation">,</span>
      handle<span class="token operator">:</span> args<span class="token punctuation">.</span>target<span class="token punctuation">,</span>
      srcAcc<span class="token operator">:</span> source<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
      tgtAcc<span class="token operator">:</span> target<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
      amount<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    crypto<span class="token punctuation">.</span><span class="token function">signObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">injectTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;toll set &lt;source&gt; &lt;toll&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sets the &lt;toll&gt; people must pay in tokens to send messages to the &lt;source&gt; account&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>source<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;toll&quot;</span><span class="token punctuation">,</span>
      srcAcc<span class="token operator">:</span> source<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
      toll<span class="token operator">:</span> args<span class="token punctuation">.</span>toll<span class="token punctuation">,</span>
      amount<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    crypto<span class="token punctuation">.</span><span class="token function">signObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">injectTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;message send &lt;message&gt; &lt;source&gt; &lt;target&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sends a &lt;message&gt; from &lt;source&gt; to &lt;target&gt;&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>source<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>target<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getToll</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>address<span class="token punctuation">,</span> args<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">toll</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>
        srcAcc<span class="token operator">:</span> source<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
        tgtAcc<span class="token operator">:</span> target<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token punctuation">{</span>
          text<span class="token operator">:</span> args<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
          timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        amount<span class="token operator">:</span> toll<span class="token punctuation">,</span>
        timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      crypto<span class="token punctuation">.</span><span class="token function">signObj</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span> source<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">injectTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;message poll &lt;to&gt; &lt;from&gt; &lt;timestamp&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;polls data for messages between &lt;to&gt; and &lt;from&gt; after specified timestamp&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> toId <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>to<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fromId <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>from<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">pollMessages</span><span class="token punctuation">(</span>toId<span class="token punctuation">,</span> fromId<span class="token punctuation">,</span> args<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>parsed<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Response is not a JSON object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>
    <span class="token string">&quot;query [account]&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Queries network data for the account associated with the given [wallet]. Otherwise, gets all network data.&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> accountId <span class="token operator">=</span> walletEntries<span class="token punctuation">[</span>args<span class="token punctuation">.</span>account<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Querying network for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        accountId <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>account<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' wallet data</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">&quot;all data&quot;</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getAccountData</span><span class="token punctuation">(</span>accountId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>parsed<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Response is not a JSON object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vorpal<span class="token punctuation">.</span><span class="token function">delimiter</span><span class="token punctuation">(</span><span class="token string">&quot;client$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="interact"><a href="#interact" class="header-anchor">#</a> Interact</h2> <p>Run the client.js file and start typing commands to interact with the network</p> <div class="language- extra-class"><pre class="language-text"><code>handle create test test
handle create test2 test2
toll set 50 test
toll set 20 test2
message send hello test test2
message send howdy test2 test
friend add test test2
query test
query test2
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs2/source/main-concepts/application-fundamentals/what-incentivizes-users.html" class="prev">
        What incentivizes users?
      </a></span> <span class="next"><a href="/docs2/source/main-concepts/building-a-poc-app/building-a-reward-system.html">
        Building a reward system
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs2/assets/js/app.4fedb86a.js" defer></script><script src="/docs2/assets/js/2.3fd0cf3c.js" defer></script><script src="/docs2/assets/js/17.e52dce7c.js" defer></script>
  </body>
</html>
